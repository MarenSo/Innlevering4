---
title: "model.rmd"
author:
- Daniel Karstad
- Maren Sognefest 
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
suppressPackageStartupMessages({
library(tidyverse)
library(lubridate)
library(modelr)
library(broom)
library(lmtest)
library(sandwich)
library(viridis)
})
knitr::opts_chunk$set(echo=FALSE, include = FALSE)
```

# Modeller

## Leser inn data

```{r reading file}
pm2 <- read_csv("data/pm2.csv", show_col_types = FALSE)
```

Vi er ute etter fylkesnummeret, for å lage en ny fylke faktorvariabel. (De to første siffrene i kommunenummeret). Vi bruker mutate() som funksjon for å hente ut deler av en tekststreng. Lager også en faktorvariabel fra årsvariabelen. Og skalerer variabelen Trade_pc.

```{r konvertering til faktor}
pm2 <- pm2 %>% 
  mutate(
    fnr = (str_sub(knr, 1,2)),
    aar_f = (str_sub(aar))
  )
```

```{r parserer faktorer}
pm2 %>% 
  mutate(
    fnr = parse_factor(fnr, levels = fnr),
    aar_f = parse_factor(aar_f, levels = aar_f)
  )
```

```{r skalerer Trade_pc}
pm2 <- pm2 %>%mutate(Trade_pc_100K = Trade_pc/100000) 
```

```{r visuell kontroll}
head(pm2, n = 4)
```

##Modell

```{r vi starter med følgende oppgitte modell}
mod1 <- 'pm2 ~ aar_f + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K'
```


### i.Generer et lm objekt (lm1) utfra mod1 og datasettet pm2.

```{r}
lm1 <- lm(mod1)
```

### ii. Legg residualene fra den lineære modellen til datasettet pm2.

```{r legger til residualer}
pm2 %>% add_residuals(lm1)
```

## Forklaring:

### i.

### ii.

## Test for heteroskedastisitet

### i.

```{r bptest}
bptest(lm1)
```

```{r}
library(gvlma)
gvlma(lm1)
```

### ii.

### iii.

```{r}
coeftest(lm1)
```

```{r}
vcovHC(lm1)
```

### iv.

```{r}
pm2 <- pm2 %>%
  add_residuals(lm1)
```

### v.

```{r}
pm2 <- pm2 %>%
  mutate(aar_d =make_date(aar))
```

### vi.

```{r}
pm2 <- pm2 %>%
  mutate(fylke = substr(knr, start = 1, stop = 2)) 
```

### vii. + viii + ix + x

```{r}
pm2 %>%
  filter(fylke %in% c("01", "02", "03", "11", "12")) %>% 
  unnest(c(fylke)) %>%
  group_by(fylke, aar_d) %>%
  summarize(mean_fylke = mean(resid)
            ) %>% 
  ggplot(aes(x = aar_d, y = mean_fylke, colour = fylke)) +
  geom_line(lwd=1) +
  theme(legend.position = "bottom")+
  geom_hline(yintercept = 0, colour = "orange")
```




