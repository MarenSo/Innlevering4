---
title: "R Notebook"
output: html_notebook
---

```{r setup}
suppressPackageStartupMessages({
library(PxWebApiData)
library(tidyverse)
library(lubridate)
library(dplyr)
library(stringr)
})
knitr::opts_chunk$set(echo=FALSE, include = FALSE)
```

#Gjennomsnittlig kvadratmeterpris

```{r kommuner}
# vector med relevante kommunenummer
load("knr.Rdata")
```


```{r loade data}
load("knr.Rdata")
```

```{r pm2_raw}
pm2_raw <- ApiData(
urlToData = "06035",
Region = knr,
ContentsCode = "KvPris",
Boligtype = "01",
Tid = c(as.character(2002:2017))
)
```

```{r forenkle navn}
names(pm2_raw)[[1]] <- "desc"
```

```{r data_og_navn}
pm2 <- pm2_raw$dataset %>% 
  select(-Boligtype, -ContentsCode, -NAstatus) %>% 
  rename(
    knr = Region,
    aar = Tid,
    pm2 = value)
pm2 <- pm2 %>% 
  mutate(knavn = pm2_raw$desc$region) %>% 
mutate(
knavn = pm2_raw$desc$region)
```


```{r teste mønster}
load("test_string_tib.Rdata")
# Legg inn regex mønster
moenster <- '\\s*\\([\\d\\s-]*\\d*\\)\\s*$'
test_string_tib %>%
mutate(
knavn = str_replace(knavn, moenster, "")
)
```
```{r endre til nye knavn}
pm2 %>%
mutate(
knavn = str_replace(knavn, moenster, "")
)
```

```{r antall na}
pm2 %>% 
  summarise(across(everything(), ~ sum(is.na(.))))
```

```{r alternativt}
pm2 %>%
  map_df(is.na) %>% map_df(sum) %>% 
  as_tibble()
```

```{r complete cases 2006_1}
pm2fra2006 <- pm2 %>% 
filter(aar >= 2006) %>% 
pivot_wider(
  names_from = aar,
  values_from = pm2,
)
```


Complete cases i perioden 2006-2017: 
```{r complete cases 2006_2}
pm2fra2006 %>%
  complete.cases() %>% 
  sum()
```


```{r complete cases 2008_1}
pm2fra2008 <- pm2 %>% 
filter (aar >= 2008) %>% 
pivot_wider(
  names_from = aar,
  values_from = pm2,
)
```

Complete cases i perioden 2008-2017: 
```{r complete cases 2008_2}
pm2fra2008 %>%
  complete.cases() %>% 
  sum()
```

```{r rydde}
# Time to clean up
rm(test_string_tib, pm2_raw)
```

#Befolkning

```{r fra ssb}
pop_08_17_ya_raw <- ApiData (
  urlToData = "07459",
  Region = knr,
  Kjonn = c(1, 2),
  Alder = list("agg:TredeltGrupperingB2",
                 c("F20-64")),
  Tid = c(as.character(2008:2017))
) $dataset %>% 
  select(-ContentsCode, -Alder)
```

```{r utvidelse}
pop_08_17_ya <- pop_08_17_ya_raw %>%
  pivot_wider(
    id_cols = c(Region, Tid),
    names_from = Kjonn,
    names_prefix = "sex",
    values_from = value
 )
```
